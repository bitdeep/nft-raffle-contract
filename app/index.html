<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sample Site</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/3.0.0-rc.5/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="abi-nft.js"></script>
    <script src="abi-main.js?v1"></script>

    <script>
        // web3 functions to operate on blockchain (connected to metamask)
        let web3;

        // first user address connected, ie, wallet address
        let account;

        // contract object to make calls
        let contract = '0x4ddfB56bb1e4cAac4Eb8EdA0e146ED71866261A0', main;

        let listing_fee;

        async function accountLoad() {
            if (window.ethereum) {
                const r = await window.ethereum.request({method: 'eth_requestAccounts'});
                web3 = new Web3(window.ethereum);
                account = r[0];
                return true;
            }
            return false;
        }

        async function bootstrap() {
            const enabled = await accountLoad();
            if (enabled) {
                $('#account').val(account);
                initContract();
                getAllNnft();
            } else {
                $('#ethEnabled').html('no')
            }
        }

        async function initContract() {
            main = new web3.eth.Contract(abi_main, contract);
            const blockNumber = await web3.eth.getBlockNumber();
            $('#blockNumber').html('Block: ' + blockNumber);

            const balance_wei = (await web3.eth.getBalance(account)).toString();
            const balance = web3.utils.fromWei(balance_wei);
            $('#balance').html('My Balance: ' + balance);

            const balanceOfContract_wei = (await web3.eth.getBalance(contract)).toString();
            const balanceOfContract = web3.utils.fromWei(balanceOfContract_wei);
            $('#balanceOfContract').html('Balance of Contract: ' + balanceOfContract);

        }
        async function getAllNnft(){
            const list = await main.methods.getAllNnft().call();
            let html = '';
            for( let i in list ){
                const address = list[i];
                const NFT = await main.methods.nfts(address).call();
                const status = NFT.status; //: "1"
                if( status != 1 )
                    continue; // only active nft
                const fee = NFT.fee; //: "10"
                const listing_fee = NFT.listing_fee/1e18; //: "10000000000000000000"
                const listing_fee_recipient = NFT.listing_fee_recipient; //: "0x10377a6d900f43D0b1aD699E99CfF6F1800aCD4C"
                const name = NFT.name; //: "TestNFT"
                const royalties = NFT.royalties; //: "20"
                const royalties_recipient = NFT.royalties_recipient; //: "0x10377a6d900f43D0b1aD699E99CfF6F1800aCD4C"

                const tg = NFT.tg; //: "t.me/testnft"
                const twitter = NFT.twitter; //: "twitter.com/testnft"

                const line = `
                    <h1>${name} (<a href="https://cronoscan.com/token/${address}#inventory" target="_blank">...${address.substr(address.length-4)}</a>)</h1>
                    <a href="${twitter}" class="badge bg-secondary">${twitter}</a>
                    <a href="${tg}" class="badge bg-secondary">${tg}</a>
                    <small>
                    <i>
                        buy fee: ${fee}%, listing_fee: ${listing_fee} CRO, royalties: ${royalties}%
                    </i>
                    </small>
                    `;
                html += line;
                html += addRaffleForm();
            }
            $('#main').html(html);
        }
        function addRaffleForm(index, nft){
            let html = `<p><span class="badge bg-primary">Add raffle:</span>

max buy: <input type="text" name="_max_per_user" style="width: 80px" placeholder="3"/>
token id: <input type="text" name="token_id" style="width: 80px" placeholder="0"/>
price (in cro/decimal): <input type="text" name="_price" style="width: 80px" placeholder="10" />
size/units: <input type="text" name="_total" style="width: 80px" placeholder="10" />

<button type="button" class="btn btn-sm btn-primary" onclick="create_raffle(${index}, '${nft}')">Create raffle</button>
            </p>`;
            return html;
        }
    </script>

</head>
<body onload="bootstrap()">

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <span class="navbar-brand mb-0 h1">Raffle NFT</span>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="#" id="blockNumber">...</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="balance">...</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="balanceOfContract">...</a>
            </li>
        </ul>
    </div>
    <span class="navbar-brand mb-0 ">Raffle NFT Marketplace</span>
</nav>

<div class="container">
    <div class="row align-items-start p-3">
        <div class="col">
            <div id="main">
                Wait...
            </div>
        </div>
    </div>
</div>

</body>
</html>
